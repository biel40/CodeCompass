<div class="detail-page">
  @if (isLoading()) {
    <div class="loading anim-fade-in">
      <div class="loading-spinner" aria-hidden="true"></div>
      <span>Cargando bono...</span>
    </div>
  } @else if (!bundle()) {
    <div class="not-found anim-fade-in">
      <div class="not-found-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="12" cy="12" r="10" />
          <line x1="15" y1="9" x2="9" y2="15" />
          <line x1="9" y1="9" x2="15" y2="15" />
        </svg>
      </div>
      <h2>Bono no encontrado</h2>
      <a [routerLink]="['/students', student()?.id]" class="btn-primary">Volver al estudiante</a>
    </div>
  } @else {
    <header class="page-header anim-fade-in">
      <a [routerLink]="['/students', student()?.id]" class="back-link">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <polyline points="15 18 9 12 15 6" />
        </svg>
        Volver a {{ student()?.fullName }}
      </a>
      <div class="header-content">
        <div class="bundle-header">
          <div class="bundle-icon" [class]="bundle()!.status">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
              <line x1="16" y1="2" x2="16" y2="6" />
              <line x1="8" y1="2" x2="8" y2="6" />
              <line x1="3" y1="10" x2="21" y2="10" />
            </svg>
          </div>
          <div>
            <h1>{{ bundle()!.name }}</h1>
            <p>
              <span class="status-badge" [class]="bundle()!.status">{{ getStatusLabel(bundle()!.status) }}</span>
              @if (bundle()!.isPaid) {
                <span class="paid-badge">Pagado</span>
              } @else {
                <span class="unpaid-badge">Pendiente de pago</span>
              }
            </p>
          </div>
        </div>
        <div class="header-actions">
          <a [routerLink]="['/students', student()?.id, 'bundles', bundle()!.id, 'edit']" class="btn-edit">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
            </svg>
            Editar
          </a>
          <button (click)="onDelete()" class="btn-delete" type="button">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <polyline points="3 6 5 6 21 6" />
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
            </svg>
            Eliminar
          </button>
        </div>
      </div>
    </header>

    <div class="content-grid anim-fade-in anim-delay-1">
      @if (errorMessage()) {
        <div class="error-alert" role="alert">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <circle cx="12" cy="12" r="10" />
            <line x1="15" y1="9" x2="9" y2="15" />
            <line x1="9" y1="9" x2="15" y2="15" />
          </svg>
          {{ errorMessage() }}
        </div>
      }

      <!-- Progress Card -->
      <section class="progress-card">
        <div class="progress-header">
          <h3>Progreso del Bono</h3>
          @if (!isEditingProgress()) {
            <button (click)="onEditProgress()" class="btn-edit-progress" type="button" title="Editar progreso">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
              </svg>
            </button>
          }
        </div>
        <div class="progress-ring-container">
          <svg class="progress-ring" viewBox="0 0 100 100">
            <circle class="progress-bg" cx="50" cy="50" r="42" />
            <circle
              class="progress-fill"
              cx="50"
              cy="50"
              r="42"
              [style.strokeDashoffset]="264 - (264 * progressPercentage()) / 100"
            />
          </svg>
          <div class="progress-text">
            @if (isEditingProgress()) {
              <div class="progress-edit-container">
                <button
                  (click)="onEditedClassesChange(editedClassesUsed() - 1)"
                  class="btn-progress-adjust"
                  type="button"
                  [disabled]="editedClassesUsed() <= 0"
                  aria-label="Reducir una clase"
                >
                  −
                </button>
                <input
                  type="number"
                  [ngModel]="editedClassesUsed()"
                  (ngModelChange)="onEditedClassesChange($event)"
                  class="progress-input"
                  [attr.min]="0"
                  [attr.max]="bundle()!.totalClasses"
                  aria-label="Clases usadas"
                />
                <button
                  (click)="onEditedClassesChange(editedClassesUsed() + 1)"
                  class="btn-progress-adjust"
                  type="button"
                  [disabled]="editedClassesUsed() >= bundle()!.totalClasses"
                  aria-label="Añadir una clase"
                >
                  +
                </button>
              </div>
            } @else {
              <span class="progress-value">{{ bundle()!.classesUsed }}</span>
            }
            <span class="progress-label">de {{ bundle()!.totalClasses }}</span>
          </div>
        </div>

        @if (isEditingProgress()) {
          <div class="progress-edit-actions">
            <button
              (click)="onCancelEditProgress()"
              class="btn-cancel-edit"
              type="button"
              [disabled]="isSavingProgress()"
            >
              Cancelar
            </button>
            <button
              (click)="onSaveProgress()"
              class="btn-save-edit"
              type="button"
              [disabled]="isSavingProgress()"
            >
              @if (isSavingProgress()) {
                <span class="loading-spinner small" aria-hidden="true"></span>
                Guardando...
              } @else {
                Guardar
              }
            </button>
          </div>
        } @else {
          <p class="remaining">
            @if (remainingClasses() > 0) {
              Quedan <strong>{{ remainingClasses() }}</strong> clases
            } @else {
              <strong>¡Bono completado!</strong>
            }
          </p>
          @if (remainingClasses() > 0) {
            <button (click)="onAddSession()" class="btn-add-session" [disabled]="isAddingSession()" type="button">
              @if (isAddingSession()) {
                <span class="loading-spinner small" aria-hidden="true"></span>
                Añadiendo...
              } @else {
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                  <line x1="12" y1="5" x2="12" y2="19" />
                  <line x1="5" y1="12" x2="19" y2="12" />
                </svg>
                Registrar clase de hoy
              }
            </button>
          }
        }
      </section>

      <!-- Info Card -->
      <section class="info-card">
        <h3>Información</h3>
        <dl>
          <dt>Precio total</dt>
          <dd class="price">{{ bundle()!.totalPrice }}€</dd>
          <dt>Precio por clase</dt>
          <dd>{{ bundle()!.pricePerClass.toFixed(2) }}€</dd>
          <dt>Fecha de inicio</dt>
          <dd>{{ formatDate(bundle()!.startsAt) }}</dd>
          @if (bundle()!.expiresAt) {
            <dt>Fecha de expiración</dt>
            <dd>{{ formatDate(bundle()!.expiresAt!) }}</dd>
          }
          @if (bundle()!.paymentDate) {
            <dt>Fecha de pago</dt>
            <dd>{{ formatDate(bundle()!.paymentDate!) }}</dd>
          }
        </dl>
        @if (!bundle()!.isPaid) {
          <button (click)="onMarkAsPaid()" class="btn-mark-paid" type="button">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <polyline points="20 6 9 17 4 12" />
            </svg>
            Marcar como pagado
          </button>
        }
      </section>

      <!-- Notes Card -->
      @if (bundle()!.notes) {
        <section class="info-card notes-card">
          <h3>Notas</h3>
          <p class="notes">{{ bundle()!.notes }}</p>
        </section>
      }

      <!-- Sessions List -->
      <section class="sessions-card">
        <div class="section-header">
          <h3>Historial de Clases</h3>
          <span class="session-count">{{ sessions().length }} sesiones</span>
        </div>
        @if (sessions().length === 0) {
          <div class="empty-sessions">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
              <line x1="16" y1="2" x2="16" y2="6" />
              <line x1="8" y1="2" x2="8" y2="6" />
              <line x1="3" y1="10" x2="21" y2="10" />
            </svg>
            <p>No hay clases registradas</p>
          </div>
        } @else {
          <ul class="sessions-list">
            @for (session of sessions(); track session.id) {
              <li class="session-item">
                <div class="session-date">
                  <span class="day">{{ formatShortDate(session.sessionDate) }}</span>
                  <span class="duration">{{ session.durationMinutes }} min</span>
                </div>
                <div class="session-info">
                  @if (isEditingSession(session.id)) {
                    <div class="session-edit-form">
                      <input
                        type="text"
                        [ngModel]="editedSessionTopic()"
                        (ngModelChange)="editedSessionTopic.set($event)"
                        class="session-topic-input"
                        placeholder="Tema de la clase..."
                        aria-label="Tema de la sesión"
                        (keyup.enter)="onSaveSessionTopic()"
                        (keyup.escape)="onCancelSessionEdit()"
                      />
                      <div class="session-edit-actions">
                        <button
                          (click)="onCancelSessionEdit()"
                          class="btn-cancel-session"
                          type="button"
                          [disabled]="isSavingSession()"
                          title="Cancelar"
                        >
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <line x1="18" y1="6" x2="6" y2="18" />
                            <line x1="6" y1="6" x2="18" y2="18" />
                          </svg>
                        </button>
                        <button
                          (click)="onSaveSessionTopic()"
                          class="btn-save-session"
                          type="button"
                          [disabled]="isSavingSession()"
                          title="Guardar"
                        >
                          @if (isSavingSession()) {
                            <span class="loading-spinner small" aria-hidden="true"></span>
                          } @else {
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                              <polyline points="20 6 9 17 4 12" />
                            </svg>
                          }
                        </button>
                      </div>
                    </div>
                  } @else {
                    <button (click)="onEditSessionTopic(session)" class="topic-button" type="button" title="Editar tema">
                      @if (session.topic) {
                        <span class="topic">{{ session.topic }}</span>
                      } @else {
                        <span class="topic muted">Sin tema</span>
                      }
                      <svg class="edit-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
                      </svg>
                    </button>
                    @if (session.notes) {
                      <span class="session-notes">{{ session.notes }}</span>
                    }
                  }
                </div>
                @if (!isEditingSession(session.id)) {
                  <button (click)="onDeleteSession(session)" class="btn-remove-session" type="button" title="Eliminar sesión">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                      <line x1="18" y1="6" x2="6" y2="18" />
                      <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                  </button>
                }
              </li>
            }
          </ul>
        }
      </section>
    </div>
  }
</div>
