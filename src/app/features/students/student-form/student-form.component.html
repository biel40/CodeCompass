<div class="form-page">
  <header class="page-header anim-fade-in">
    <a routerLink="/students" class="back-link">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <polyline points="15 18 9 12 15 6" />
      </svg>
      Volver
    </a>
    <h1>{{ isEditMode() ? 'Editar' : 'Nuevo' }} Estudiante</h1>
  </header>

  <form [formGroup]="studentForm" (ngSubmit)="onSubmit()" class="student-form anim-fade-in anim-delay-1">
    @if (errorMessage()) {
      <div class="error-alert" role="alert">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <circle cx="12" cy="12" r="10" />
          <line x1="15" y1="9" x2="9" y2="15" />
          <line x1="9" y1="9" x2="15" y2="15" />
        </svg>
        {{ errorMessage() }}
      </div>
    }

    <!-- Avatar Picker -->
    <div class="avatar-picker">
      <div class="avatar-preview" [class.has-image]="avatarPreview()">
        @if (avatarPreview()) {
          <img [src]="avatarPreview()" alt="Avatar del estudiante" />
          <button type="button" class="avatar-remove" (click)="removeAvatar()" title="Eliminar imagen">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <line x1="18" y1="6" x2="6" y2="18" />
              <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
          </button>
        } @else {
          <span class="avatar-initials">{{ getInitials(studentForm.controls.fullName.value || 'NN') }}</span>
        }
      </div>
      <div class="avatar-actions">
        <label for="avatarInput" class="btn-upload">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="17 8 12 3 7 8" />
            <line x1="12" y1="3" x2="12" y2="15" />
          </svg>
          {{ avatarPreview() ? 'Cambiar imagen' : 'Subir imagen' }}
        </label>
        <input
          type="file"
          id="avatarInput"
          accept="image/*"
          (change)="onFileSelected($event)"
          class="visually-hidden"
        />
        <span class="avatar-hint">JPG, PNG o GIF. Máx. 2MB</span>
      </div>
    </div>

    <div class="form-group">
      <label for="fullName">Nombre Completo *</label>
      <input id="fullName" type="text" formControlName="fullName" placeholder="Nombre del alumno" />
      @if (studentForm.get('fullName')?.touched && studentForm.get('fullName')?.errors?.['required']) {
        <span class="error-text">El nombre es requerido</span>
      }
    </div>

    <div class="form-group">
      <label for="email">Email</label>
      <input id="email" type="email" formControlName="email" placeholder="email@ejemplo.com (opcional)" />
      @if (studentForm.get('email')?.touched && studentForm.get('email')?.errors?.['email']) {
        <span class="error-text">El email no es válido</span>
      }
    </div>

    <div class="form-group">
      <label for="level">Nivel</label>
      <select id="level" formControlName="level">
        <option value="beginner">Principiante</option>
        <option value="intermediate">Intermedio</option>
        <option value="advanced">Avanzado</option>
      </select>
    </div>

    <div class="form-group">
      <label for="notes">Notas</label>
      <textarea id="notes" formControlName="notes" rows="4" placeholder="Observaciones sobre el alumno..."></textarea>
    </div>

    <div class="form-actions">
      <a routerLink="/students" class="btn-cancel">Cancelar</a>
      <button type="submit" [disabled]="studentForm.invalid || isLoading()" class="btn-primary">
        @if (isLoading()) {
          <div class="btn-spinner" aria-hidden="true"></div>
          Guardando...
        } @else {
          {{ isEditMode() ? 'Actualizar' : 'Crear' }} Estudiante
        }
      </button>
    </div>
  </form>
</div>
