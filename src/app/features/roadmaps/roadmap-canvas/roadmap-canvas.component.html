<section
  class="canvas-wrapper"
  #canvasContainer
  tabindex="0"
  role="application"
  aria-label="Visor interactivo de roadmap. Usa las flechas para navegar, +/- para zoom, Escape para deseleccionar"
  [style.cursor]="canvasCursor()"
  (wheel)="onWheel($event)"
  (mousedown)="onMouseDown($event)"
  (mousemove)="onMouseMove($event)"
  (mouseup)="onMouseUp()"
  (mouseleave)="onMouseLeave()"
  (keydown)="onKeyDown($event)"
>
  <!-- Controles de zoom -->
  <div class="zoom-controls" role="group" aria-label="Controles de zoom">
    <button
      type="button"
      class="zoom-btn"
      (click)="zoomIn()"
      aria-label="Acercar"
      title="Acercar (+)"
    >
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <circle cx="11" cy="11" r="8"/>
        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
        <line x1="11" y1="8" x2="11" y2="14"/>
        <line x1="8" y1="11" x2="14" y2="11"/>
      </svg>
    </button>
    <span class="zoom-level" aria-live="polite">{{ zoomPercentage() }}</span>
    <button
      type="button"
      class="zoom-btn"
      (click)="zoomOut()"
      aria-label="Alejar"
      title="Alejar (-)"
    >
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <circle cx="11" cy="11" r="8"/>
        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
        <line x1="8" y1="11" x2="14" y2="11"/>
      </svg>
    </button>
    <button
      type="button"
      class="zoom-btn zoom-btn-reset"
      (click)="resetZoom()"
      aria-label="Restablecer vista"
      title="Restablecer vista (0)"
    >
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
        <path d="M3 3v5h5"/>
      </svg>
    </button>
  </div>

  <!-- Instrucciones de uso -->
  <div class="canvas-instructions" aria-hidden="true">
    <span><kbd>Arrastrar</kbd> para mover</span>
    <span><kbd>Rueda</kbd> para zoom</span>
    <span><kbd>Clic</kbd> en nodo para detalles</span>
  </div>

  <!-- Canvas principal -->
  <div class="canvas" [style.transform]="canvasTransform()">
    <!-- Conexiones SVG -->
    <svg
      class="connections-layer"
      viewBox="0 0 2000 2000"
      preserveAspectRatio="none"
      aria-hidden="true"
    >
      <defs>
        <!-- Marcador de flecha para conexiones -->
        <marker
          id="arrowhead"
          markerWidth="10"
          markerHeight="7"
          refX="9"
          refY="3.5"
          orient="auto"
        >
          <polygon points="0 0, 10 3.5, 0 7" fill="var(--color-primary-light)" />
        </marker>
        <marker
          id="arrowhead-optional"
          markerWidth="10"
          markerHeight="7"
          refX="9"
          refY="3.5"
          orient="auto"
        >
          <polygon points="0 0, 10 3.5, 0 7" fill="var(--color-text-muted)" />
        </marker>
      </defs>

      @for (connection of roadmap().connections; track connection.id) {
        <path
          class="connection-path"
          [class.connection-required]="connection.isRequired"
          [class.connection-optional]="!connection.isRequired"
          [attr.d]="getConnectionPath(connection)"
          [attr.marker-end]="connection.isRequired ? 'url(#arrowhead)' : 'url(#arrowhead-optional)'"
        />
      }
    </svg>

    <!-- Nodos -->
    @for (node of roadmap().nodes; track node.id) {
      <article
        class="canvas-node"
        [class]="getNodeTypeClass(node.type)"
        [class.node-selected]="selectedNode()?.id === node.id"
        [class.node-optional]="node.isOptional"
        [style.left.px]="node.position.x"
        [style.top.px]="node.position.y"
        role="button"
        tabindex="0"
        [attr.aria-label]="node.title + ', ' + getNodeTypeLabel(node.type) + (node.isOptional ? ', opcional' : '')"
        [attr.aria-pressed]="selectedNode()?.id === node.id"
        (click)="selectNode(node); $event.stopPropagation()"
        (keydown.enter)="selectNode(node)"
        (keydown.space)="selectNode(node); $event.preventDefault()"
      >
        <div class="node-header">
          <span class="node-type-icon" [class]="'icon-' + node.type" aria-hidden="true">
            @switch (node.type) {
              @case ('topic') {
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>
                </svg>
              }
              @case ('project') {
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                </svg>
              }
              @case ('milestone') {
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                </svg>
              }
              @case ('checkpoint') {
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
              }
            }
          </span>
          <span class="node-type-label">{{ getNodeTypeLabel(node.type) }}</span>
          @if (node.isOptional) {
            <span class="node-optional-badge">Opcional</span>
          }
        </div>
        <h4 class="node-title">{{ node.title }}</h4>
        <p class="node-description">{{ node.description }}</p>
        <div class="node-footer">
          <span class="node-hours">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
            {{ node.estimatedHours }}h
          </span>
          @if (node.resources.length > 0) {
            <span class="node-resources">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
              </svg>
              {{ node.resources.length }}
            </span>
          }
        </div>
      </article>
    }
  </div>

  <!-- Panel de detalles del nodo seleccionado -->
  @if (selectedNode(); as node) {
    <aside class="node-detail-panel" role="complementary" aria-labelledby="detail-title">
      <header class="detail-header">
        <div class="detail-type" [class]="getNodeTypeClass(node.type)">
          @switch (node.type) {
            @case ('topic') {
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>
              </svg>
            }
            @case ('project') {
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
              </svg>
            }
            @case ('milestone') {
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
              </svg>
            }
            @case ('checkpoint') {
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
              </svg>
            }
          }
          <span>{{ getNodeTypeLabel(node.type) }}</span>
        </div>
        <button
          type="button"
          class="detail-close"
          (click)="deselectNode()"
          aria-label="Cerrar panel de detalles"
        >
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </header>

      <div class="detail-content">
        <h3 id="detail-title" class="detail-title">{{ node.title }}</h3>
        <p class="detail-description">{{ node.description }}</p>

        <dl class="detail-meta">
          <dt>Tiempo estimado</dt>
          <dd>{{ node.estimatedHours }} horas</dd>
          <dt>Estado</dt>
          <dd>
            <span class="status-badge" [class.optional]="node.isOptional">
              {{ node.isOptional ? 'Opcional' : 'Requerido' }}
            </span>
          </dd>
        </dl>

        @if (node.resources.length > 0) {
          <section class="detail-resources">
            <h4>Recursos ({{ node.resources.length }})</h4>
            <ul class="resources-list">
              @for (resource of node.resources; track resource.id) {
                <li class="resource-item">
                  <a [href]="resource.url" target="_blank" rel="noopener noreferrer">
                    <span class="resource-type">{{ resource.type }}</span>
                    <span class="resource-title">{{ resource.title }}</span>
                    @if (resource.isPremium) {
                      <span class="premium-badge" aria-label="Contenido premium">â˜…</span>
                    }
                  </a>
                </li>
              }
            </ul>
          </section>
        } @else {
          <p class="no-resources">Sin recursos asociados</p>
        }
      </div>
    </aside>
  }
</section>
